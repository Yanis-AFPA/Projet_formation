---
# --- INFRASTRUCTURE DOCKER ---
- name: Créer un réseau Docker pour BookStack
  community.docker.docker_network:
    name: bookstack_net
  tags: bookstack

- name: Lancer MariaDB
  community.docker.docker_container:
    name: bookstack_db
    image: linuxserver/mariadb
    state: started
    restart_policy: unless-stopped
    networks:
      - name: bookstack_net
    env:
      PUID: "1000"
      PGID: "1000"
      MYSQL_ROOT_PASSWORD: "{{ bookstack_db_root_password }}"
      MYSQL_DATABASE: "{{ bookstack_db_name }}"
      MYSQL_USER: "{{ bookstack_db_user }}"
      MYSQL_PASSWORD: "{{ bookstack_db_password }}"
    volumes:
      - /opt/bookstack/db_data:/config
  tags: bookstack

- name: Lancer BookStack
  community.docker.docker_container:
    name: bookstack_app
    image: linuxserver/bookstack
    state: started
    restart_policy: unless-stopped
    networks:
      - name: bookstack_net
    ports:
      - "8080:80"
    env:
      PUID: "1000"
      PGID: "1000"
      APP_URL: "https://wiki.grp-ay.lab"
      APP_KEY: "{{ bookstack_app_key }}"
      DB_HOST: "bookstack_db"
      DB_DATABASE: "{{ bookstack_db_name }}"
      DB_USERNAME: "{{ bookstack_db_user }}"
      DB_PASSWORD: "{{ bookstack_db_password }}"
    volumes:
      - /opt/bookstack/app_data:/config
  tags: bookstack

# --- PHASE DE NETTOYAGE ET RECONSTRUCTION (IMPORT) ---

- name: Initialiser les variables d'import
  set_fact:
    target_book_name: "Documentation Proxmox"
    existing_pages_map: {}
  tags: bookstack

- name: "Chercher si le livre existe déjà pour suppression"
  ansible.builtin.uri:
    url: "{{ bookstack_url }}/api/books?filter[name]={{ target_book_name | urlencode }}"
    method: GET
    headers:
      Authorization: "Token {{ bookstack_api_token_id }}:{{ bookstack_api_token_secret }}"
  register: search_to_delete
  tags: bookstack

- name: "Supprimer le livre existant (Nettoyage complet)"
  ansible.builtin.uri:
    url: "{{ bookstack_url }}/api/books/{{ search_to_delete.json.data[0].id }}"
    method: DELETE
    headers:
      Authorization: "Token {{ bookstack_api_token_id }}:{{ bookstack_api_token_secret }}"
    status_code: [204]
  when: search_to_delete.json.total > 0
  tags: bookstack

- name: "Créer le nouveau livre (Base saine)"
  ansible.builtin.uri:
    url: "{{ bookstack_url }}/api/books"
    method: POST
    headers:
      Authorization: "Token {{ bookstack_api_token_id }}:{{ bookstack_api_token_secret }}"
      Content-Type: "application/json"
    body_format: json
    body:
      name: "{{ target_book_name }}"
      description: "Import automatique (Rebuild complet)"
    status_code: [200, 201]
  register: created_book
  tags: bookstack

- name: "Définir l'ID du nouveau livre"
  set_fact:
    real_book_id: "{{ created_book.json.id }}"
  tags: bookstack

# --- TRAITEMENT ET IMPORT DES PAGES ---

- name: "Traiter et importer chaque fichier Markdown"
  include_tasks: _import_single_page.yml
  vars:
    target_book_id_dyn: "{{ real_book_id }}"
  loop: "{{ lookup('fileglob', bookstack_md_source_dir ~ '/*.md', wantlist=True) }}"
  loop_control:
    loop_var: current_md_file
  when: real_book_id is defined
  tags: bookstack